name: test

on:
  workflow_call:
  workflow_dispatch:
    inputs:
      run_id:
        description: "wheel workflow run ID to test"
        required: true
        type: string

jobs:
  test_macos:
    strategy:
      fail-fast: false
      matrix:
        platform:
          - name: macos-15_arm64
            runs_on: macos-15
        python_version:
          - "3.14"
    runs-on: ${{ matrix.platform.runs_on }}
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v5

      - uses: astral-sh/setup-uv@v6
        with:
          enable-cache: false

      - run: |
          uv python pin ${{ matrix.python_version }}

      - name: Download wheel artifact (workflow_call)
        if: ${{ !github.event.inputs.run_id }}
        uses: actions/download-artifact@v5
        with:
          name: ${{ matrix.platform.name }}_python-${{ matrix.python_version }}
          path: wheelhouse/

      - name: Download wheel artifact (workflow_dispatch)
        if: ${{ github.event.inputs.run_id }}
        uses: actions/download-artifact@v5
        with:
          name: ${{ matrix.platform.name }}_python-${{ matrix.python_version }}
          path: wheelhouse/
          run-id: ${{ github.event.inputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: List downloaded wheels
        run: |
          echo "Downloaded wheel files:"
          ls -la wheelhouse/

      - name: Install wheel
        run: |
          uv venv
          uv pip install pytest pytest-timeout pytest-asyncio aioquic cryptography
          uv pip install wheelhouse/*.whl

      - name: Run tests
        run: |
          # UV_NO_SYNC=1 を指定する理由:
          # uv run はデフォルトで実行前に pyproject.toml/uv.lock と環境を同期する
          # この同期により、uv pip install でインストールした wheel が削除され、
          # 元のソースコードがインストールされてしまう
          # UV_NO_SYNC=1 で同期をスキップし、インストール済みの wheel を使用する
          uv run pytest tests/ --timeout=60 --tb=short -v
        env:
          UV_NO_SYNC: 1

  test_ubuntu:
    strategy:
      fail-fast: false
      matrix:
        platform:
          - name: ubuntu-22.04_x86_64
            runs_on: ubuntu-22.04
          - name: ubuntu-22.04_arm64
            runs_on: ubuntu-22.04-arm
        python_version:
          - "3.14"
    runs-on: ${{ matrix.platform.runs_on }}
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v5

      - uses: astral-sh/setup-uv@v6
        with:
          enable-cache: false

      - name: Setup Python via uv
        run: |
          uv python pin ${{ matrix.python_version }}

      - name: Download wheel artifact (workflow_call)
        if: ${{ !github.event.inputs.run_id }}
        uses: actions/download-artifact@v5
        with:
          name: ${{ matrix.platform.name }}_python-${{ matrix.python_version }}
          path: wheelhouse/

      - name: Download wheel artifact (workflow_dispatch)
        if: ${{ github.event.inputs.run_id }}
        uses: actions/download-artifact@v5
        with:
          name: ${{ matrix.platform.name }}_python-${{ matrix.python_version }}
          path: wheelhouse/
          run-id: ${{ github.event.inputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: List downloaded wheels
        run: |
          echo "Downloaded wheel files:"
          ls -la wheelhouse/

      - name: Install wheel
        run: |
          uv venv
          uv pip install pytest pytest-timeout pytest-asyncio aioquic cryptography
          uv pip install wheelhouse/*.whl

      - name: Run tests
        run: |
          uv run pytest tests/ --timeout=60 --tb=short -v
        env:
          UV_NO_SYNC: 1

  test_windows:
    strategy:
      fail-fast: false
      matrix:
        platform:
          - name: windows-2025_x86_64
            runs_on: windows-2025
        python_version:
          - "3.14"
    runs-on: ${{ matrix.platform.runs_on }}
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v5

      - uses: astral-sh/setup-uv@v6
        with:
          enable-cache: false

      - name: Setup Python via uv
        shell: bash
        run: |
          uv python pin ${{ matrix.python_version }}

      - name: Download wheel artifact (workflow_call)
        if: ${{ !github.event.inputs.run_id }}
        uses: actions/download-artifact@v5
        with:
          name: ${{ matrix.platform.name }}_python-${{ matrix.python_version }}
          path: wheelhouse/

      - name: Download wheel artifact (workflow_dispatch)
        if: ${{ github.event.inputs.run_id }}
        uses: actions/download-artifact@v5
        with:
          name: ${{ matrix.platform.name }}_python-${{ matrix.python_version }}
          path: wheelhouse/
          run-id: ${{ github.event.inputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: List downloaded wheels
        shell: bash
        run: |
          echo "Downloaded wheel files:"
          ls -la wheelhouse/

      - name: Install wheel
        shell: bash
        run: |
          uv venv
          uv pip install pytest pytest-timeout pytest-asyncio aioquic cryptography
          uv pip install wheelhouse/*.whl

      - name: Run tests
        shell: bash
        run: |
          uv run pytest tests/ --timeout=60 --tb=short -v
        env:
          UV_NO_SYNC: 1
